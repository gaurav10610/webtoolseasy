import{CORE_URL as e,FFMessageType as r}from"./const.js";import{ERROR_UNKNOWN_MESSAGE_TYPE as t,ERROR_NOT_LOADED as a,ERROR_IMPORT_FAILURE as s}from"./errors.js";let ffmpeg,load=async({coreURL:t=e,wasmURL:a,workerURL:f})=>{let i=!ffmpeg,m=t,p=a||t.replace(/.js$/g,".wasm"),g=f||t.replace(/.js$/g,".worker.js");try{importScripts(m)}catch{if(self.createFFmpegCore=(await import(m)).default,!self.createFFmpegCore)throw s}return(ffmpeg=await self.createFFmpegCore({mainScriptUrlOrBlob:`${m}#${btoa(JSON.stringify({wasmURL:p,workerURL:g}))}`})).setLogger(e=>self.postMessage({type:r.LOG,data:e})),ffmpeg.setProgress(e=>self.postMessage({type:r.PROGRESS,data:e})),i},exec=({args:e,timeout:r=-1})=>{ffmpeg.setTimeout(r),ffmpeg.exec(...e);let t=ffmpeg.ret;return ffmpeg.reset(),t},writeFile=({path:e,data:r})=>(ffmpeg.FS.writeFile(e,r),!0),readFile=({path:e,encoding:r})=>ffmpeg.FS.readFile(e,{encoding:r}),deleteFile=({path:e})=>(ffmpeg.FS.unlink(e),!0),rename=({oldPath:e,newPath:r})=>(ffmpeg.FS.rename(e,r),!0),createDir=({path:e})=>(ffmpeg.FS.mkdir(e),!0),listDir=({path:e})=>{let r=ffmpeg.FS.readdir(e),t=[];for(let a of r){let s=ffmpeg.FS.stat(`${e}/${a}`),f=ffmpeg.FS.isDir(s.mode);t.push({name:a,isDir:f})}return t},deleteDir=({path:e})=>(ffmpeg.FS.rmdir(e),!0);self.onmessage=async({data:{id:e,type:s,data:f}})=>{let i=[],m;try{if(s!==r.LOAD&&!ffmpeg)throw a;switch(s){case r.LOAD:m=await load(f);break;case r.EXEC:m=exec(f);break;case r.WRITE_FILE:m=writeFile(f);break;case r.READ_FILE:m=readFile(f);break;case r.DELETE_FILE:m=deleteFile(f);break;case r.RENAME:m=rename(f);break;case r.CREATE_DIR:m=createDir(f);break;case r.LIST_DIR:m=listDir(f);break;case r.DELETE_DIR:m=deleteDir(f);break;default:throw t}}catch(p){self.postMessage({id:e,type:r.ERROR,data:p.toString()});return}m instanceof Uint8Array&&i.push(m.buffer),self.postMessage({id:e,type:s,data:m},i)};